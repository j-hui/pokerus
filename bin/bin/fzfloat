#!/usr/bin/env sh

# fzfloat
#
# Lifts fzf to run in a separate terminal application, which can be managed as
# a standalone GUI component.
#
# Requires a POSIX-compliant shell, fzf, and alacritty.
#
# References:
# - https://gitlab.com/Seirdy/term-dmenu
# - https://serverfault.com/questions/187182/need-script-to-redirect-stdin-stdout-to-named-pipes

class="float-term"

die () {
  echo "$@" >&2
  exit 1
}

command -v sh         >/dev/null  || die "Missing dependency: sh"
command -v fzf        >/dev/null  || die "Missing dependency: fzf"
command -v alacritty  >/dev/null  || die "Missing dependency: alacritty"

export FZF_DEFAULT_OPTS="$* $FZF_DEFAULT_OPTS"

trap exit CHLD
trap "rm -f /tmp/fzfloat-in /tmp/fzfloat-out" EXIT
[ -p /tmp/fzfloat-in  ] || mkfifo /tmp/fzfloat-in
[ -p /tmp/fzfloat-out ] || mkfifo /tmp/fzfloat-out

{ while read -r LINE; do printf '%s\n' "$LINE"; done } <&0 >/tmp/fzfloat-in &

# shellcheck disable=SC2016
alacritty --class "Alacritty,$class" -e sh -c 'fzf </tmp/fzfloat-in >/tmp/fzfloat-out' &
# st -c "$class" -e sh -c 'fzf </tmp/fzfloat-in >/tmp/fzfloat-out' &

# sleep 0.1
# xdotool search --class "$class" \
#   set_window --overrideredirect 1 \
#   windowunmap \
#   windowmap \
#   windowmove 50% 100 \
#   windowfocus --sync

cat /tmp/fzfloat-out
wait

# vi:ft=sh
